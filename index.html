<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hexacola AI Image Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    /* Bendrieji stiliai */
    body {
      margin: 0;
      font-family: "Courier Prime", monospace;
      background-color: #1e1e1e; /* Tamsus fonas */
      color: #ffffff; /* Balta spalva tekstui */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212; /* Dar tamsesnis fonas */
      color: #e0e0e0;
    }
    .main-wrapper {
      display: flex;
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      box-sizing: border-box;
    }
    /* Sidebar for Chat and Prompt Generators */
    .sidebar {
      flex: 1;
      max-width: 300px;
      margin-right: 20px;
      background-color: rgba(30, 30, 30, 0.95);
      border: 2px solid #444;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
      transition: background-color 0.3s, border-color 0.3s;
      display: flex;
      flex-direction: column;
      height: fit-content;
    }
    body.dark-mode .sidebar {
      background-color: rgba(18, 18, 18, 0.95);
      border-color: #666;
    }
    .sidebar h2 {
      margin-top: 0;
      color: #00ffcc;
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.5);
    }
    .sidebar .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .sidebar .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #00ffcc;
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.5);
    }
    .sidebar .input-group button {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      margin-bottom: 10px;
    }
    .sidebar .input-group button.generate-prompt {
      background-color: #00ffcc;
    }
    .sidebar .input-group button.generate-prompt:hover {
      background-color: #00e6b3;
      transform: translateY(-2px);
    }
    /* Library Button */
    .sidebar .library-button {
      background-color: #007BFF;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sidebar .library-button:hover {
      background-color: #0056b3;
    }
    /* Chat Area */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 300px;
      background-color: rgba(18, 18, 18, 0.95);
      border: 2px solid #666;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
      overflow-y: auto;
      margin-bottom: 20px;
      max-height: 400px;
    }
    .chat-message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      background-color: #333333;
      color: #ffffff;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .chat-message.user {
      background-color: #00b3a4;
      align-self: flex-end;
    }
    .chat-message.assistant {
      background-color: #555555;
      align-self: flex-start;
    }
    .chat-input-group {
      display: flex;
      gap: 10px;
    }
    .chat-input-group input {
      flex: 1;
      padding: 10px;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      background-color: #2c2c2c;
      color: #ffffff;
      transition: background-color 0.3s, border-color 0.3s;
      box-shadow: inset 0 0 10px rgba(0, 255, 204, 0.1);
    }
    body.dark-mode .chat-input-group input {
      background-color: #1e1e1e;
      border-color: #00b3a4;
      color: #e0e0e0;
    }
    .chat-input-group button {
      padding: 10px 15px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      color: #ffffff;
      background-color: #00ffcc;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .chat-input-group button:hover {
      background-color: #00e6b3;
      transform: translateY(-2px);
    }
    /* Main Container for Image Generation and Library */
    .container, .library-container {
      flex: 2;
      background-color: rgba(30, 30, 30, 0.95); /* Tamsus puslapio fonas */
      border: 2px solid #444;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
      transition: background-color 0.3s, border-color 0.3s;
      position: relative;
      display: none; /* Hidden by default */
    }
    .container.active, .library-container.active {
      display: block;
    }
    body.dark-mode .container,
    body.dark-mode .library-container {
      background-color: rgba(18, 18, 18, 0.95);
      border-color: #666;
    }
    .header {
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header h1, .library-container h2 {
      font-size: 2.5em;
      margin: 0;
      color: #00ffcc; /* Ry≈°kus antra≈°tƒós tekstas */
      text-shadow: 0 0 10px rgba(0, 255, 204, 0.7);
      text-align: center;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 25px;
      text-align: left;
      position: relative;
    }
    .input-group label {
      margin-bottom: 8px;
      font-weight: bold;
      color: #00ffcc;
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.5);
    }
    .input-group textarea, .input-group select {
      padding: 12px;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      resize: vertical;
      font-size: 1em;
      background-color: #2c2c2c;
      color: #ffffff;
      transition: background-color 0.3s, border-color 0.3s;
      box-shadow: inset 0 0 10px rgba(0, 255, 204, 0.1);
      width: 100%;
    }
    body.dark-mode .input-group textarea,
    body.dark-mode .input-group select {
      background-color: #1e1e1e;
      border-color: #00b3a4;
      color: #e0e0e0;
    }
    /* Stilizacijos naujajai persona≈æo apra≈°ymo funkcijai */
    .input-group button#addCharacterBtn {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 1.2em;
      background-color: #00ffcc;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 40px;
      height: 40px;
      position: absolute;
      right: 0;
      top: 0;
    }
    .input-group button#addCharacterBtn:hover {
      background-color: #00e6b3;
    }
    .additional-character-group {
      margin-bottom: 15px;
      position: relative;
    }
    .additional-character-group button {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 1em;
      background-color: #ff4d4d;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      position: absolute;
      right: 0;
      top: 0;
    }
    .additional-character-group button:hover {
      background-color: #e60000;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 25px;
      text-align: left;
    }
    .options .option {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 15px;
      width: 48%;
    }
    .options .option label {
      margin-bottom: 8px;
      font-weight: bold;
      color: #00ffcc;
      text-shadow: 0 0 5px rgba(0, 255, 204, 0.5);
    }
    .options .option input,
    .options .option select {
      padding: 8px;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      font-size: 1em;
      background-color: #333333;
      color: #ffffff;
      transition: background-color 0.3s, border-color 0.3s;
      width: 100%;
      box-shadow: inset 0 0 10px rgba(0, 255, 204, 0.1);
    }
    body.dark-mode .options .option input,
    body.dark-mode .options .option select {
      background-color: #1e1e1e;
      border-color: #00b3a4;
      color: #e0e0e0;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .buttons button {
      padding: 12px 25px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .buttons button.generate {
      background-color: #00ffcc;
    }
    .buttons button.generate:hover {
      background-color: #00e6b3;
      transform: translateY(-2px);
    }
    .buttons button.dark-mode-toggle {
      background-color: #555555;
    }
    .buttons button.dark-mode-toggle:hover {
      background-color: #777777;
      transform: translateY(-2px);
    }
    .buttons button.auto-toggle {
      background-color: #ffcc00;
      color: #000000;
      position: relative;
    }
    .buttons button.auto-toggle.active {
      background-color: #ffaa00;
    }
    .buttons button.auto-toggle:hover {
      background-color: #ffaa00;
      transform: translateY(-2px);
    }
    .buttons button.auto-toggle::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%; /* Rodoma vir≈° mygtuko */
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 0.9em;
      z-index: 1;
    }
    .buttons button.auto-toggle:hover::after {
      opacity: 1;
    }
    .buttons button.clear-library {
      background-color: #ff4444;
    }
    .buttons button.clear-library:hover {
      background-color: #cc0000;
      transform: translateY(-2px);
    }
    .generated-image, .library-container .generated-image {
      margin-top: 25px;
      position: relative;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .image-container {
      position: relative;
      width: 200px;
      /* Fiksuotas plotis, kad b≈´t≈≥ matomi keli vaizdai */
    }
    .image-container img {
      width: 100%;
      height: auto;
      border: 2px solid #00ffcc;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      display: block;
      filter: contrast(1.2) brightness(1.1) sepia(0.3) saturate(1.5) hue-rotate(-10deg);
      image-rendering: pixelated;
    }
    .image-container img:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.7);
    }
    /* Teksto apra≈°ymas ant nuotraukos */
    .caption {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      padding: 10px;
      box-sizing: border-box;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      font-size: 0.9em;
      opacity: 0;
      transition: opacity 0.3s;
      max-height: 50%;
      overflow: auto;
      text-align: left;
    }
    .image-container:hover .caption {
      opacity: 1;
    }
    .download-options {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .download-options select,
    .download-options button {
      padding: 5px;
      font-size: 0.8em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: rgba(255, 255, 255, 0.8);
      color: #000;
      transition: background-color 0.3s;
    }
    .download-options button:hover {
      background-color: rgba(255, 255, 255, 1);
    }
    /* Laikmatis / ƒÆkrovimo indikatorius */
    .loader {
      border: 8px solid #f3f3f3; /* ≈†viesus fonas */
      border-top: 8px solid #00ffcc; /* Ry≈°kus spalvos vir≈°utinis ≈æiedas */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 30, 30, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      z-index: 9;
      display: none; /* Prad≈æioje nematomas */
      flex-direction: column;
      gap: 15px;
    }
    .progress-container {
      width: 80%;
      background-color: #555;
      border-radius: 25px;
      overflow: hidden;
      margin-top: 15px;
    }
    .progress-bar {
      height: 20px;
      width: 0%;
      background-color: #00ffcc;
      transition: width 0.3s;
    }
    @keyframes spin {
      0% { transform: rotate(0deg) translate(-50%, -50%); }
      100% { transform: rotate(360deg) translate(-50%, -50%); }
    }
    footer {
      margin-top: 40px;
      font-size: 0.8em;
      color: #aaaaaa;
      text-align: center;
    }
    footer a {
      color: #00ffcc;
      text-decoration: none;
      font-weight: bold;
    }
    footer a:hover {
      text-decoration: underline;
    }
    @media (max-width: 900px) {
      .main-wrapper {
        flex-direction: column;
        align-items: center;
      }
      .sidebar {
        max-width: none;
        margin-right: 0;
        margin-bottom: 20px;
        width: 100%;
      }
      .container, .library-container {
        width: 100%;
      }
    }
    @media (max-width: 600px) {
      .options .option {
        width: 100%;
      }
      .buttons {
        flex-direction: column;
        gap: 15px;
      }
      .loader {
        width: 40px;
        height: 40px;
        border-width: 6px;
      }
      .image-container {
        width: 100%;
      }
      .caption {
        font-size: 0.8em;
        padding: 8px;
      }
      .progress-container {
        width: 90%;
      }
      .download-options {
        flex-direction: column;
      }
    }
    /* Modal Stiliai */
    .modal {
      display: none; /* Prad≈æioje nematomas */
      position: fixed;
      z-index: 100;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
    }
    .modal-content {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 1000px;
      animation-name: zoom;
      animation-duration: 0.6s;
    }
    #caption {  
      animation-name: zoom;
      animation-duration: 0.6s;
    }
    @keyframes zoom {
      from {transform:scale(0)} 
      to {transform:scale(1)}
    }
    .close {
      position: absolute;
      top: 30px;
      right: 45px;
      color: #ffffff;
      font-size: 40px;
      font-weight: bold;
      transition: color 0.3s;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: #00ffcc;
      text-decoration: none;
      cursor: pointer;
    }
    @media only screen and (max-width: 700px){
      .modal-content {
        width: 100%;
      }
      .close {
        top: 15px;
        right: 35px;
        font-size: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <!-- Sidebar for Chat and Prompt Generators -->
    <div class="sidebar">
      <h2>AI Prompt Generator</h2>
      <div class="input-group">
        <label>Generuoti Apra≈°ymƒÖ:</label>
        <button class="generate-prompt" onclick="generateRandomPrompt('background')"><i class="fas fa-lightbulb"></i> GENERUOTI ƒÆ FONƒÑ</button>
        <button class="generate-prompt" onclick="generateRandomPrompt('character')"><i class="fas fa-lightbulb"></i> GENERUOTI ƒÆ PERSONA≈ΩƒÑ</button>
      </div>
      <!-- Library Button -->
      <div class="input-group">
        <button class="library-button" onclick="showLibrary()"><i class="fas fa-images"></i> LIBRARY</button>
      </div>
      <!-- Chat Interface -->
      <h2>Hexacola Chat</h2>
      <div class="chat" id="chat">
        <!-- Chat messages will appear here -->
      </div>
      <div class="chat-input-group">
        <input type="text" id="chatInput" placeholder="Ra≈°ykite ≈æinutƒô..." />
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Si≈≥sti</button>
      </div>
    </div>

    <!-- Main Container for Image Generation -->
    <div class="container active" id="generatorContainer">
      <div class="header">
        <h1>Hexacola AI Image Generator</h1>
      </div>
      <div class="input-group">
        <label for="backgroundPrompt">Background Description:</label>
        <textarea id="backgroundPrompt" placeholder="Pvz., Saulƒólydis kalnuose, ramus e≈æeras..."></textarea>
      </div>
      <div class="input-group">
        <label for="characterPrompt">Character Description:</label>
        <textarea id="characterPrompt" placeholder="Pvz., Jaunas riteris su sidabru kruopelƒó..."></textarea>
        <button type="button" id="addCharacterBtn" onclick="addCharacterDescription()" title="Pridƒóti papildomƒÖ persona≈æo apra≈°ymƒÖ">+</button>
      </div>
      <div id="additionalCharacterDescriptions"></div>
      <div class="input-group">
        <label for="negativePrompt">Negative Prompt:</label>
        <textarea id="negativePrompt" placeholder="Nenoriu logotipo, i≈°kraipyto stiliaus..."></textarea>
      </div>
      <div class="options">
        <div class="option">
          <label for="model">Modelis:</label>
          <select id="model">
            <option value="flux" selected>Flux</option>
            <option value="flux-anime">Flux-Anime</option>
            <option value="flux-3d">Flux-3D</option>
            <option value="flux-pro">Flux-Pro</option>
            <option value="flux-realism">Flux-Realism</option>
            <option value="flux-cablyal">Flux-CablyAl</option>
            <option value="any-dark">Any-Dark</option>
            <option value="turbo">Turbo</option>
            <option value="Unity">Unity</option>
          </select>
        </div>
        <div class="option">
          <label for="width">Plotis (px):</label>
          <input type="number" id="width" value="512" min="64" max="2048" />
        </div>
        <div class="option">
          <label for="height">Auk≈°tis (px):</label>
          <input type="number" id="height" value="512" min="64" max="2048" />
        </div>
        <div class="option">
          <label for="seed">Seed:</label>
          <input type="number" id="seed" placeholder="Palikite tu≈°ƒçiƒÖ..." />
        </div>
        <div class="option">
          <label for="imageOptions">Kiek paveikslƒóli≈≥:</label>
          <input type="number" id="imageOptions" value="1" min="1" max="10" />
        </div>
        <div class="option">
          <label for="style">Stilius:</label>
          <select id="style">
            <option value="None">None</option>
            <option value="Film">Film</option>
            <option value="Pixel Art">Pixel Art</option>
            <option value="Anime">Anime</option>
            <option value="Realistic">Realistic</option>
            <option value="Mix">Mix</option>
            <option value="Storyboard">Storyboard</option>
            <option value="Film Noir">Film Noir</option>
            <option value="Vintage">Vintage</option>
            <option value="Graphic Design">Graphic Design</option>
            <option value="Cartoon">Cartoon</option>
            <option value="Watercolor">Watercolor</option>
            <option value="Surrealism">Surrealism</option>
            <option value="Comics Style">Comics Style</option>
          </select>
        </div>
      </div>
      <div class="buttons">
        <button class="generate" onclick="generateImage()"><i class="fas fa-magic"></i> GENERUOTI</button>
        <button class="auto-toggle" onclick="toggleAutoMode()" id="autoToggleBtn" data-tooltip="Automati≈°kai optimizuoja apra≈°ymus naudojant AI"><i class="fas fa-robot"></i> AUTO OFF</button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> üåô</button>
      </div>
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer" hidden>
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="generated-image" id="generatedImage"></div>
      <!-- ƒÆkrovimo indikatorius -->
      <div class="overlay" id="overlay">
        <div class="loader"></div>
        <div id="timer">Generuojama: 0s</div>
        <!-- Progress Bar -->
        <div class="progress-container" id="progressOverlay" hidden>
          <div class="progress-bar" id="progressOverlayBar"></div>
        </div>
      </div>
    </div>

    <!-- Library Container -->
    <div class="library-container" id="libraryContainer">
      <h2>Library</h2>
      <div class="generated-image" id="libraryImages">
        <!-- Saved images will appear here -->
      </div>
      <div class="buttons">
        <button class="generate" onclick="showGenerator()"><i class="fas fa-arrow-left"></i> GENERATOR</button>
        <button class="download" onclick="downloadAllLibraryImages()"><i class="fas fa-download"></i> ATSISI≈≤STI VISKƒÑ</button>
        <button class="clear-library" onclick="clearLibrary()"><i class="fas fa-trash-alt"></i> I≈†VALYTI LIBRARY</button>
      </div>
    </div>
  </div>
  
  <!-- Modal for Fullscreen Image -->
  <div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>

  <footer>
    <p>
      API dokumentacija:
      <a href="https://github.com/pollinations/pollinations/blob/master/APIDOCS.md" target="_blank">Pollinations.AI GitHub</a>
    </p>
    <p>
      Sukurta su ‚ù§Ô∏è naudojant
      <a href="https://pollinations.ai/" target="_blank">Pollinations.AI</a>.
    </p>
  </footer>

  <script>
    let timerInterval;
    let autoMode = false;
    let totalImages = 0;
    let generatedImagesCount = 0;

    // I≈°saugoti nustatymus vietiniame saugykloje
    function saveSettings() {
      const backgroundPrompt = document.getElementById('backgroundPrompt').value;
      const characterPrompt = document.getElementById('characterPrompt').value;
      const negativePrompt = document.getElementById('negativePrompt').value;
      const model = document.getElementById('model').value;
      const width = document.getElementById('width').value;
      const height = document.getElementById('height').value;
      const seed = document.getElementById('seed').value;
      const imageOptions = document.getElementById('imageOptions').value;
      const style = document.getElementById('style').value;

      // Rinkti papildomus persona≈æo apra≈°ymus
      const additionalCharacterDescriptions = [];
      const additionalGroups = document.querySelectorAll('.additional-character-group textarea');
      additionalGroups.forEach(textarea => {
        const desc = textarea.value.trim();
        if (desc) {
          additionalCharacterDescriptions.push(desc);
        }
      });

      localStorage.setItem('backgroundPrompt', backgroundPrompt);
      localStorage.setItem('characterPrompt', characterPrompt);
      localStorage.setItem('negativePrompt', negativePrompt);
      localStorage.setItem('model', model);
      localStorage.setItem('width', width);
      localStorage.setItem('height', height);
      localStorage.setItem('seed', seed);
      localStorage.setItem('imageOptions', imageOptions);
      localStorage.setItem('style', style);
      localStorage.setItem('autoMode', autoMode);
      localStorage.setItem('additionalCharacterDescriptions', JSON.stringify(additionalCharacterDescriptions));
    }

    // ƒÆkelti nustatymus i≈° vietinƒós saugyklos
    function loadSettings() {
      const backgroundPrompt = localStorage.getItem('backgroundPrompt');
      const characterPrompt = localStorage.getItem('characterPrompt');
      const negativePrompt = localStorage.getItem('negativePrompt');
      const model = localStorage.getItem('model');
      const width = localStorage.getItem('width');
      const height = localStorage.getItem('height');
      const seed = localStorage.getItem('seed');
      const imageOptions = localStorage.getItem('imageOptions');
      const style = localStorage.getItem('style');
      const savedAutoMode = localStorage.getItem('autoMode');
      const additionalCharacterDescriptions = JSON.parse(localStorage.getItem('additionalCharacterDescriptions') || '[]');

      if (backgroundPrompt) document.getElementById('backgroundPrompt').value = backgroundPrompt;
      if (characterPrompt) document.getElementById('characterPrompt').value = characterPrompt;
      if (negativePrompt) document.getElementById('negativePrompt').value = negativePrompt;
      if (model) document.getElementById('model').value = model;
      if (width) document.getElementById('width').value = width;
      if (height) document.getElementById('height').value = height;
      if (seed) document.getElementById('seed').value = seed;
      if (imageOptions) document.getElementById('imageOptions').value = imageOptions;
      if (style) document.getElementById('style').value = style;
      if (savedAutoMode === 'true') {
        autoMode = true;
        document.getElementById('autoToggleBtn').classList.add('active');
        document.getElementById('autoToggleBtn').innerHTML = '<i class="fas fa-robot"></i> AUTO ON';
      } else {
        autoMode = false;
        document.getElementById('autoToggleBtn').classList.remove('active');
        document.getElementById('autoToggleBtn').innerHTML = '<i class="fas fa-robot"></i> AUTO OFF';
      }

      // ƒÆkelti papildomus persona≈æo apra≈°ymus
      additionalCharacterDescriptions.forEach(desc => {
        addCharacterDescription(desc);
      });
    }

    // Pradinis ƒØkƒólimas
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadDarkMode();
      setupModal();
      initializeNegativePrompt();
      loadGeneratedImages();
      loadLibraryImages();
      disableImageDownload();
    });

    // Inicializuoti Negative Prompt su numatytuoju tekstu
    function initializeNegativePrompt() {
      const negativePrompt = document.getElementById('negativePrompt');
      if (!negativePrompt.value) {
        negativePrompt.value = "low quality, blurry, bad anatomy, out of focus, noise, duplicate, watermark, text, ugly, messy";
      }
    }

    // Tamsusis re≈æimas
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const toggleBtn = document.querySelector('.dark-mode-toggle');
      if (document.body.classList.contains('dark-mode')) {
        toggleBtn.innerHTML = '<i class="fas fa-sun"></i> ‚òÄÔ∏è';
      } else {
        toggleBtn.innerHTML = '<i class="fas fa-moon"></i> üåô';
      }
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ƒÆkelti tamsaus re≈æimo nustatymus
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
        document.querySelector('.dark-mode-toggle').innerHTML = '<i class="fas fa-sun"></i> ‚òÄÔ∏è';
      } else {
        document.querySelector('.dark-mode-toggle').innerHTML = '<i class="fas fa-moon"></i> üåô';
      }
    }

    // Pridƒóti ‚ÄûAUTO‚Äú re≈æimo toggle funkcijƒÖ
    function toggleAutoMode() {
      autoMode = !autoMode;
      const toggleBtn = document.getElementById('autoToggleBtn');
      if (autoMode) {
        toggleBtn.classList.add('active');
        toggleBtn.innerHTML = '<i class="fas fa-robot"></i> AUTO ON';
      } else {
        toggleBtn.classList.remove('active');
        toggleBtn.innerHTML = '<i class="fas fa-robot"></i> AUTO OFF';
      }
      localStorage.setItem('autoMode', autoMode);
    }

    // Funkcija, kuri prideda stiliaus apra≈°ymƒÖ ƒØ promptƒÖ
    function appendStyleToPrompt(prompt, style) {
      const styleDescriptions = {
        'Film': `${prompt}, cinematic masterpiece, shot with an anamorphic 35mm lens, ultra-wide aspect ratio, natural film grain, rich and moody cinematic color palette, deep contrast, dynamic range, soft and detailed lighting, natural bokeh, shallow depth of field, evocative storytelling, authentic vintage film aesthetics, timeless Hollywood style`,
        'Pixel Art': `${prompt}, in classic pixel art style, inspired by retro games like Final Fantasy and Chrono Trigger, 16-bit aesthetic, carefully crafted pixel details, balanced color palette, nostalgic and vibrant tones, smooth shading, and authentic retro charm`,
        'Anime': `${prompt}, in anime style inspired by classics like Attack on Titan and Demon Slayer, vivid and dynamic compositions, vibrant yet harmonious color schemes, expressive and detailed character designs, dramatic lighting, intricate line work, fluid motion elements, and a cinematic anime atmosphere`,
        'Realistic': `${prompt}, in hyper-realistic style, photorealistic details, meticulously rendered textures, lifelike proportions, dynamic and natural lighting, realistic depth of field, authentic environments, nuanced color grading, and true-to-life materials`,
        'Storyboard': `${prompt}, in hand-drawn black-and-white storyboard style, rough pencil sketch aesthetic, emphasizing composition, perspective, and dynamic camera angles, clear character blocking, cinematic framing, sequential flow, and annotations for action and dialogue cues`,
        'Film Noir': `${prompt}, in classic film noir style, high contrast black-and-white imagery, dramatic chiaroscuro lighting, deep shadows, atmospheric fog, urban backdrops, vintage aesthetics, fedoras and trench coats, suspenseful mood, and intense character expressions`,
        'Vintage': `${prompt}, in vintage style, muted and earthy color palette, soft film grain, faded textures, timeless composition, delicate vignetting, nostalgic atmosphere, classic typography, and retro-inspired design elements`,
        'Graphic Design': `${prompt}, in modern graphic design style, clean and balanced layouts, bold typography, striking color palettes, geometric shapes, high contrast, minimalist aesthetics, layered compositions, and visually compelling visuals tailored for branding or digital media`,
        'Cartoon': `${prompt}, in Cartoon Network-inspired style, bold and dynamic outlines, exaggerated yet balanced proportions, quirky character designs, vibrant and contrasting color palettes, playful and expressive animations, simplified but impactful backgrounds, lighthearted tone, and a touch of surreal humor reminiscent of shows like Adventure Time, The Amazing World of Gumball, and Dexter's Laboratory`,
        'Watercolor': `${prompt}, in delicate watercolor painting style, soft brush strokes, pastel and muted tones, organic textures, flowing gradients, and a dreamy, artistic atmosphere reminiscent of classic hand-painted illustrations`,
        'Surrealism': `${prompt}, in surreal style, dreamlike imagery, abstract forms, unconventional compositions, and a blend of reality and imagination, reminiscent of Salvador Dal√≠'s artworks`,
        'Comics Style': `${prompt}, in vibrant comics style, bold black outlines, dynamic panel compositions, expressive character poses, exaggerated proportions, halftone patterns, action-packed scenes, vibrant primary colors, dramatic speech bubbles, and a storytelling aesthetic reminiscent of Marvel and DC classics`,
        'Mix': appendMixStyleToPrompt(prompt)
      };
      return styleDescriptions[style] || prompt; // "None" arba kiti nenumatyti stiliai
    }

    // Funkcija, kuri parenka atsitiktinius du stilius Mix re≈æimui
    function getRandomStyles() {
      const styles = ['Film', 'Pixel Art', 'Anime', 'Realistic', 'Storyboard', 'Film Noir', 'Vintage', 'Graphic Design', 'Cartoon', 'Watercolor', 'Surrealism', 'Comics Style'];
      let first = styles[Math.floor(Math.random() * styles.length)];
      let second = styles[Math.floor(Math.random() * styles.length)];
      while (second === first) {
        second = styles[Math.floor(Math.random() * styles.length)];
      }
      return `${first} and ${second}`;
    }

    // Funkcija, kuri prideda stiliaus apra≈°ymƒÖ Mix re≈æimui
    function appendMixStyleToPrompt(prompt) {
      const randomStyles = getRandomStyles();
      return `${prompt}, in ${randomStyles} styles, combining elements from both styles for a unique and engaging image`;
    }

    // Modal konfig≈´racija
    function setupModal() {
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImage");
      const closeBtn = document.getElementsByClassName("close")[0];

      // U≈ædaryti modalƒÖ
      closeBtn.onclick = function() { 
        modal.style.display = "none";
      }

      // U≈ædaryti modalƒÖ, jei paspaud≈æiama bet kur kitur
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      // Atidaryti modalƒÖ, kai spustelƒóta ant vaizdo
      document.getElementById('generatedImage').addEventListener('click', function(event) {
        if(event.target.tagName === 'IMG') {
          modal.style.display = "block";
          modalImg.src = event.target.src;
        }
      });

      // Atidaryti modalƒÖ, kai spustelƒóta ant vaizdo i≈° bibliotekos
      document.getElementById('libraryImages').addEventListener('click', function(event) {
        if(event.target.tagName === 'IMG') {
          modal.style.display = "block";
          modalImg.src = event.target.src;
        }
      });
    }

    // Function to add an additional character description
    function addCharacterDescription(description = '') {
      const container = document.getElementById('additionalCharacterDescriptions');
      
      const descriptionCount = container.children.length;
      if (descriptionCount >= 5) { // Limit to 5 additional descriptions
        alert('Galite pridƒóti iki 5 papildom≈≥ persona≈æo apra≈°ym≈≥.');
        return;
      }

      const newGroup = document.createElement('div');
      newGroup.classList.add('input-group', 'additional-character-group');

      const label = document.createElement('label');
      label.textContent = `Additional Character Description ${descriptionCount + 1}:`;
      label.setAttribute('for', `additionalCharacterPrompt${descriptionCount + 1}`);

      const textarea = document.createElement('textarea');
      textarea.id = `additionalCharacterPrompt${descriptionCount + 1}`;
      textarea.placeholder = 'Pvz., ilgasis ≈°aknys, puikiai sutvarkyta ≈°viesa...';
      textarea.value = description;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = '‚Äì'; // Remove button
      removeBtn.title = 'Pa≈°alinti ≈°ƒØ apra≈°ymƒÖ';
      removeBtn.onclick = () => {
        container.removeChild(newGroup);
        saveSettings(); // Save changes
      };

      newGroup.appendChild(label);
      newGroup.appendChild(textarea);
      newGroup.appendChild(removeBtn);

      container.appendChild(newGroup);
    }

    // Function to show the library section
    function showLibrary() {
      document.getElementById('generatorContainer').classList.remove('active');
      document.getElementById('libraryContainer').classList.add('active');
    }

    // Function to show the generator section
    function showGenerator() {
      document.getElementById('libraryContainer').classList.remove('active');
      document.getElementById('generatorContainer').classList.add('active');
    }

    // Function to add image to library gallery
    function addImageToLibraryGallery(url, prompt, model, width, height, seed, mimeType) {
      const libraryImagesDiv = document.getElementById('libraryImages');
      const imageContainer = document.createElement('div');
      imageContainer.classList.add('image-container');

      const imgElement = document.createElement('img');
      imgElement.src = url;
      imgElement.alt = 'Sugeneruotas vaizdas';
      imgElement.title = 'Spauskite norƒódami padidinti';
      imgElement.dataset.type = mimeType; // Store MIME type for correct file extension
      imageContainer.appendChild(imgElement);

      // Pridƒóti tekstinƒØ apra≈°ymƒÖ ant nuotraukos
      const caption = document.createElement('div');
      caption.classList.add('caption');
      caption.innerHTML = `
        <strong>Prompt:</strong> ${prompt}<br>
        <strong>Model:</strong> ${model}<br>
        <strong>Dimensions:</strong> ${width}px x ${height}px<br>
        <strong>Seed:</strong> ${seed}
      `;
      imageContainer.appendChild(caption);

      // Pridƒóti download options
      const downloadOptions = document.createElement('div');
      downloadOptions.classList.add('download-options');

      const formatSelect = document.createElement('select');
      formatSelect.innerHTML = `
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
        <option value="webp">WEBP</option>
      `;
      downloadOptions.appendChild(formatSelect);

      const downloadBtn = document.createElement('button');
      downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
      downloadBtn.onclick = () => {
        const format = formatSelect.value;
        downloadImage(url, `hexacola_image_${seed}.${format}`, format);
      };
      downloadOptions.appendChild(downloadBtn);

      imageContainer.appendChild(downloadOptions);

      libraryImagesDiv.appendChild(imageContainer);
    }

    // Function to download image in selected format
    async function downloadImage(url, filename, format) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        let convertedBlob = blob;

        if (format !== blob.type.split('/')[1]) {
          const imageBitmap = await createImageBitmap(blob);
          const canvas = document.createElement('canvas');
          canvas.width = imageBitmap.width;
          canvas.height = imageBitmap.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imageBitmap, 0, 0);
          convertedBlob = await new Promise(resolve => canvas.toBlob(resolve, `image/${format}`));
        }

        const a = document.createElement('a');
        a.href = URL.createObjectURL(convertedBlob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('Atsisiuntimo klaida:', error);
        alert('Klaida atsisiunƒçiant vaizdƒÖ. Bandykite dar kartƒÖ.');
      }
    }

    // Function to load library images
    function loadLibraryImages() {
      let images = JSON.parse(localStorage.getItem('generatedImages')) || [];
      images.forEach(image => {
        addImageToLibraryGallery(image.url, image.prompt, image.model, image.width, image.height, image.seed, image.mimeType);
      });
    }

    // Function to clear library
    function clearLibrary() {
      if (confirm('Ar tikrai norite i≈°valyti visus vaizdus i≈° bibliotekos?')) {
        localStorage.removeItem('generatedImages');
        document.getElementById('libraryImages').innerHTML = '';
        alert('Library sƒókmingai i≈°valyta.');
      }
    }

    // Generuoti vaizdƒÖ
    async function generateImage() {
      const generateButton = document.querySelector('.generate');
      generateButton.disabled = true; // I≈°jungti mygtukƒÖ generavimo metu

      const backgroundPrompt = document.getElementById('backgroundPrompt').value.trim();
      const characterPrompt = document.getElementById('characterPrompt').value.trim();
      const rawNegativePrompt = document.getElementById('negativePrompt').value.trim();
      const model = document.getElementById('model').value;
      const width = document.getElementById('width').value;
      const height = document.getElementById('height').value;
      const seed = document.getElementById('seed').value;
      const imageOptions = parseInt(document.getElementById('imageOptions').value);
      const style = document.getElementById('style').value;

      // Rinkti papildomus persona≈æo apra≈°ymus
      const additionalCharacterDescriptions = [];
      const additionalGroups = document.querySelectorAll('.additional-character-group textarea');
      additionalGroups.forEach(textarea => {
        const desc = textarea.value.trim();
        if (desc) {
          additionalCharacterDescriptions.push(desc);
        }
      });

      // Patikrinti, ar nƒóra joki≈≥ apra≈°ym≈≥
      const noPrompts = !backgroundPrompt && !characterPrompt && additionalCharacterDescriptions.length === 0;

      let backgroundCombinedPrompt = '';
      let characterCombinedPrompt = '';

      if (noPrompts) {
        // Jei nƒóra joki≈≥ apra≈°ym≈≥, generuoti tiek background, tiek character
        try {
          [backgroundCombinedPrompt, characterCombinedPrompt] = await Promise.all([
            generateRandomPromptFunction('background', style),
            generateRandomPromptFunction('character', style)
          ]);
          // Priskirti sugeneruotus apra≈°ymus
          document.getElementById('backgroundPrompt').value = backgroundCombinedPrompt;
          document.getElementById('characterPrompt').value = characterCombinedPrompt;
        } catch (error) {
          console.error(error);
          alert('Nepavyko sugeneruoti atsitiktinio apra≈°ymo. Bandykite dar kartƒÖ.');
          generateButton.disabled = false;
          return;
        }
      } else {
        // Jei yra bent vienas apra≈°ymas, u≈ætikrinti, kad jis atitinka tik background arba character
        if (backgroundPrompt) {
          backgroundCombinedPrompt = backgroundPrompt;
        }
        if (characterPrompt) {
          characterCombinedPrompt = characterPrompt;
        }
      }

      // Patikrinkite, ar yra bent vienas apra≈°ymas
      if ((!backgroundCombinedPrompt && !characterCombinedPrompt)) {
        alert('Pra≈°ome ƒØvesti bent vienƒÖ fono arba persona≈æo apra≈°ymƒÖ.');
        generateButton.disabled = false;
        return;
      }

      saveSettings();

      let optimizedBackgroundPrompt = backgroundCombinedPrompt;
      let optimizedCharacterPrompt = characterCombinedPrompt;
      let optimizedNegativePrompt = "low quality, blurry, bad anatomy, out of focus, noise, duplicate, watermark, text, ugly, messy, " + rawNegativePrompt;

      if (autoMode) {
        try {
          // Optimizuoti background prompt su stiliumi
          if (backgroundCombinedPrompt) {
            optimizedBackgroundPrompt = await optimizePrompt(`Optimize the following background prompt for high-quality image generation in ${style} style: "${backgroundCombinedPrompt}"`);
          }

          // Optimizuoti character prompt su stiliumi
          if (characterCombinedPrompt) {
            optimizedCharacterPrompt = await optimizePrompt(`Optimize the following character prompt for high-quality image generation in ${style} style: "${characterCombinedPrompt}"`);
          }

          // Optimizuoti kiekvienƒÖ papildomƒÖ persona≈æo apra≈°ymƒÖ su stiliumi
          for (let i = 0; i < additionalCharacterDescriptions.length; i++) {
            additionalCharacterDescriptions[i] = await optimizePrompt(`Optimize the following character description to match the ${style} style: "${additionalCharacterDescriptions[i]}"`);
          }

          // Optimizuoti negative prompt
          if (rawNegativePrompt) {
            optimizedNegativePrompt = "low quality, blurry, bad anatomy, out of focus, noise, duplicate, watermark, text, ugly, messy, " + await optimizePrompt(`Optimize the following negative prompt to exclude unwanted elements: "${rawNegativePrompt}"`);
          }
        } catch (error) {
          console.error(error);
          alert('Klaida optimizuojant apra≈°ymus su AI. Bandykite dar kartƒÖ.');
          generateButton.disabled = false;
          return;
        }
      }

      // Integruoti papildomus persona≈æo apra≈°ymus
      let fullCharacterPrompt = optimizedCharacterPrompt;
      if (additionalCharacterDescriptions.length > 0) {
        fullCharacterPrompt += ' ' + additionalCharacterDescriptions.join(' ');
        // Pridƒóti instrukcijas i≈°laikyti stiliaus nuoseklumƒÖ
        fullCharacterPrompt += ' Ensure that all characters maintain the same style, face structure, and clothing as described above.';
      }

      // Pridƒóti auk≈°tos kokybƒós vaizdo apra≈°ymus
      let combinedPrompt = '';
      if (optimizedBackgroundPrompt && optimizedCharacterPrompt) {
        combinedPrompt = `${optimizedBackgroundPrompt}, ${fullCharacterPrompt}, with correct proportions, good perspective, and excellent composition.`;
      } else if (optimizedBackgroundPrompt) {
        combinedPrompt = `${optimizedBackgroundPrompt}, with correct proportions, good perspective, and excellent composition.`;
      } else if (optimizedCharacterPrompt) {
        combinedPrompt = `${fullCharacterPrompt}, with correct proportions, good perspective, and excellent composition.`;
      }

      if (style === 'Mix') {
        combinedPrompt = appendMixStyleToPrompt(combinedPrompt);
      } else if (style !== 'None') {
        combinedPrompt = appendStyleToPrompt(combinedPrompt, style);
      }

      // Pradƒóti kurti API URL
      let urlBase = `https://image.pollinations.ai/prompt/${encodeURIComponent(combinedPrompt)}?model=${encodeURIComponent(model)}&width=${encodeURIComponent(width)}&height=${encodeURIComponent(height)}&nologo=true`;

      if (rawNegativePrompt) {
        urlBase += `&negative=${encodeURIComponent(optimizedNegativePrompt)}`;
      }

      try {
        // Rodyti ƒØkrovimo indikatori≈≥ ir pradƒóti laikmatƒØ
        const overlay = document.getElementById('overlay');
        const timer = document.getElementById('timer');
        const progressOverlay = document.getElementById('progressOverlay');
        const progressOverlayBar = document.getElementById('progressOverlayBar');
        overlay.style.display = 'flex';
        progressOverlay.style.display = 'block';
        let seconds = 0;
        timer.textContent = `Generuojama: ${seconds}s`;
        timerInterval = setInterval(() => {
          seconds++;
          timer.textContent = `Generuojama: ${seconds}s`;
        }, 1000);

        // Pradƒóti progresijos juostos atnaujinimƒÖ
        totalImages = imageOptions;
        generatedImagesCount = 0;
        updateProgressBar();

        // I≈°valyti anksƒçiau sugeneruotus vaizdus
        const generatedImageDiv = document.getElementById('generatedImage');
        generatedImageDiv.innerHTML = ''; // U≈ækrauti prie≈° pradedant generuoti naujus vaizdus

        // Generuoti vaizdus lygiagreƒçiai su unikaliomis promptais
        const promises = [];
        for (let i = 0; i < imageOptions; i++) {
          let uniqueSeed;
          if (seed) {
            uniqueSeed = parseInt(seed) + i; // Pridƒóti skaiƒçi≈≥ prie pagrindinio seed
          } else {
            uniqueSeed = Math.floor(Math.random() * 100000); // Atsitiktinis seed
          }
          const url = `${urlBase}&seed=${encodeURIComponent(uniqueSeed)}`;
          promises.push(fetch(url).then(response => {
            if (!response.ok) {
              throw new Error('Nepavyko sugeneruoti vaizdo.');
            }
            return response.blob();
          }).catch(error => {
            console.error(`Vaizdo generavimo klaida (Seed: ${uniqueSeed}):`, error);
            return null;
          }));
        }

        const blobs = await Promise.all(promises);
        blobs.forEach((blob, index) => {
          if (blob) {
            const imgUrl = URL.createObjectURL(blob);
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');

            const imgElement = document.createElement('img');
            imgElement.src = imgUrl;
            imgElement.alt = 'Sugeneruotas vaizdas';
            imgElement.title = 'Spauskite norƒódami padidinti';
            imgElement.dataset.type = blob.type; // Store MIME type
            imageContainer.appendChild(imgElement);

            // Pridƒóti tekstinƒØ apra≈°ymƒÖ ant nuotraukos
            const caption = document.createElement('div');
            caption.classList.add('caption');
            caption.innerHTML = `
              <strong>Prompt:</strong> ${combinedPrompt}<br>
              <strong>Model:</strong> ${model}<br>
              <strong>Dimensions:</strong> ${width}px x ${height}px<br>
              <strong>Seed:</strong> ${seed ? uniqueSeed : 'Random'}
            `;
            imageContainer.appendChild(caption);

            // Pridƒóti download options
            const downloadOptions = document.createElement('div');
            downloadOptions.classList.add('download-options');

            const formatSelect = document.createElement('select');
            formatSelect.innerHTML = `
              <option value="png">PNG</option>
              <option value="jpg">JPG</option>
              <option value="webp">WEBP</option>
            `;
            downloadOptions.appendChild(formatSelect);

            const downloadBtn = document.createElement('button');
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
            downloadBtn.onclick = () => {
              const format = formatSelect.value;
              downloadImage(imgUrl, `hexacola_image_${seed ? uniqueSeed : index + 1}.${format}`, format);
            };
            downloadOptions.appendChild(downloadBtn);

            imageContainer.appendChild(downloadOptions);

            generatedImageDiv.appendChild(imageContainer);

            // Save image to localStorage
            saveImage(imgUrl, combinedPrompt, model, width, height, seed ? uniqueSeed : 'Random', blob.type);
            // Also add to library
            addImageToLibraryGallery(imgUrl, combinedPrompt, model, width, height, seed ? uniqueSeed : 'Random', blob.type);

            // Atnaujinti progresijos juostƒÖ
            generatedImagesCount++;
            updateProgressBar();
          } else {
            generatedImagesCount++;
            updateProgressBar();
          }
        });
      } catch (error) {
        console.error(error);
        alert('Klaida generuojant vaizdƒÖ. Bandykite dar kartƒÖ.');
        document.getElementById('generatedImage').innerHTML = '';
      } finally {
        // Pasibaigus generavimui, paslƒópti ƒØkrovimo indikatori≈≥ ir sustabdyti laikmatƒØ
        document.getElementById('overlay').style.display = 'none';
        clearInterval(timerInterval);
        generateButton.disabled = false;
        document.getElementById('progressOverlay').style.display = 'none';
        disableImageDownload();
      }
    }

    // Atsisi≈≥sti visus vaizdus i≈° bibliotekos
    async function downloadAllLibraryImages() {
      const images = document.querySelectorAll('#libraryImages img');
      if (images.length === 0) {
        alert('Nƒóra vaizd≈≥ atsisiuntimui.');
        return;
      }
      images.forEach((img, index) => {
        const mimeType = img.dataset.type || 'image/png'; // Default to png if type not found
        const extension = mimeType.split('/')[1] || 'png';
        const a = document.createElement('a');
        a.href = img.src;
        a.download = `hexacola_image_${index + 1}.${extension}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    // Function to update progress bar
    function updateProgressBar() {
      const progressBar = document.getElementById('progressOverlayBar');
      const progressPercentage = (generatedImagesCount / totalImages) * 100;
      progressBar.style.width = `${progressPercentage}%`;
      if (progressPercentage >= 100) {
        progressBar.style.backgroundColor = '#4caf50'; // Green when complete
      }
    }

    // Function to optimize prompt using Pollinations.AI Text Generation API
    async function optimizePrompt(prompt) {
      const response = await fetch('https://text.pollinations.ai/openai', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            { role: 'system', content: 'Tu esi Hexacola GPT ‚Äì k≈´rybingas ir universalus AI ƒØrankis, skirtas generuoti auk≈°tos kokybƒós promptus ir vaizdus, optimizuotus su Pollinations.AI. Tavo specializacija ‚Äì kurti unikalius persona≈æ≈≥ apra≈°ymus, ƒØtraukianƒçius pasauli≈≥ fonus (backgrounds), detalizuotus scenarijus ir stilingus vaizdinius apra≈°ymus, kurie puikiai dera su Pollinations.AI vaizd≈≥ generavimo galimybƒómis. Tu atsi≈ævelgi ƒØ stilistikƒÖ, spalv≈≥ paletƒô, kompozicijƒÖ ir vartotojo pageidavimus, siekdamas i≈°laikyti geriausiƒÖ vaizdo ir teksto kokybƒô. Tu visada sieki kokybi≈°k≈≥ nuotrauk≈≥ ir vaizd≈≥, atsi≈ævelgiant ƒØ detalumƒÖ ir estetikƒÖ. Tavo tikslas ‚Äì pateikti ƒØkvepianƒçius ir esteti≈°kai harmoningus rezultatus, pritaikomus literat≈´rai, ≈æaidim≈≥ dizainui, audiovizualiniams projektams ir k≈´rybinei savirai≈°kai.' },
            { role: 'user', content: prompt }
          ],
          model: 'openai', // Pollinations.AI default model
          seed: Math.floor(Math.random() * 100000),
          jsonMode: false
        }),
      });

      if (!response.ok) {
        throw new Error('Nepavyko susisiekti su AI paslauga.');
      }

      const data = await response.json();
      if (data.choices && data.choices.length > 0 && data.choices[0].message) {
        const optimizedPrompt = data.choices[0].message.content;
        return optimizedPrompt.trim();
      } else {
        throw new Error('Neteisingas AI atsakymas.');
      }
    }

    // Function to generate a random prompt using Pollinations.AI Text Generation API
    async function generateRandomPromptFunction(target, style) {
      let basePrompt = '';
      if (target === 'background') {
        basePrompt = 'Generate a creative and detailed description for a background of an AI-generated image that is unique and visually appealing. Ensure it is suitable for a high-quality image generation with appropriate style adaptations.';
      } else if (target === 'character') {
        basePrompt = 'Generate a creative and detailed description for a character of an AI-generated image that is unique and visually appealing. Ensure it is suitable for a high-quality image generation with appropriate style adaptations.';
      } else {
        throw new Error('Invalid target for prompt generation.');
      }

      const response = await fetch('https://text.pollinations.ai/openai', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            { role: 'system', content: 'Tu esi Hexacola GPT ‚Äì k≈´rybingas ir universalus AI ƒØrankis, skirtas generuoti auk≈°tos kokybƒós promptus ir vaizdus, optimizuotus su Pollinations.AI. Tavo specializacija ‚Äì kurti unikalius persona≈æ≈≥ apra≈°ymus, ƒØtraukianƒçius pasauli≈≥ fonus (backgrounds), detalizuotus scenarijus ir stilingus vaizdinius apra≈°ymus, kurie puikiai dera su Pollinations.AI vaizd≈≥ generavimo galimybƒómis. Tu atsi≈ævelgi ƒØ stilistikƒÖ, spalv≈≥ paletƒô, kompozicijƒÖ ir vartotojo pageidavimus, siekdamas i≈°laikyti geriausiƒÖ vaizdo ir teksto kokybƒô. Tu visada sieki kokybi≈°k≈≥ nuotrauk≈≥ ir vaizd≈≥, atsi≈ævelgiant ƒØ detalumƒÖ ir estetikƒÖ. Tavo tikslas ‚Äì pateikti ƒØkvepianƒçius ir esteti≈°kai harmoningus rezultatus, pritaikomus literat≈´rai, ≈æaidim≈≥ dizainui, audiovizualiniams projektams ir k≈´rybinei savirai≈°kai.' },
            { role: 'user', content: basePrompt }
          ],
          model: 'openai', // Pollinations.AI default model
          seed: Math.floor(Math.random() * 100000),
          jsonMode: false
        }),
      });

      if (!response.ok) {
        throw new Error('Nepavyko susisiekti su AI paslauga.');
      }

      const data = await response.json();
      if (data.choices && data.choices.length > 0 && data.choices[0].message) {
        let generatedPrompt = data.choices[0].message.content;
        generatedPrompt = generatedPrompt.trim();

        // Apply style if selected
        if (style && style !== 'None') {
          generatedPrompt = appendStyleToPrompt(generatedPrompt, style);
        }

        return generatedPrompt;
      } else {
        throw new Error('Neteisingas AI atsakymas.');
      }
    }

    // Define the generateRandomPrompt function that the buttons will call
    async function generateRandomPrompt(target) {
      const style = document.getElementById('style').value;
      const generateButtons = document.querySelectorAll('.generate-prompt');
      generateButtons.forEach(button => button.disabled = true); // Disable all prompt buttons during generation

      try {
        const prompt = await generateRandomPromptFunction(target, style);
        if (target === 'background') {
          document.getElementById('backgroundPrompt').value = prompt;
        } else if (target === 'character') {
          document.getElementById('characterPrompt').value = prompt;
        }
        alert(`Sƒókmingai sugeneruotas ${target} apra≈°ymas!`);
      } catch (error) {
        console.error(error);
        alert('Klaida generuojant apra≈°ymƒÖ. Bandykite dar kartƒÖ.');
      } finally {
        generateButtons.forEach(button => button.disabled = false); // Re-enable buttons after generation
      }
    }

    // Chat Functionality
    async function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      if (message === '') return;

      appendMessage('user', message);
      chatInput.value = '';

      try {
        const response = await fetch('https://text.pollinations.ai/openai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            messages: [
              { role: 'system', content: 'Tu esi Hexacola GPT ‚Äì k≈´rybingas ir universalus AI ƒØrankis, skirtas generuoti auk≈°tos kokybƒós promptus ir vaizdus, optimizuotus su Pollinations.AI. Tavo specializacija ‚Äì kurti unikalius persona≈æ≈≥ apra≈°ymus, ƒØtraukianƒçius pasauli≈≥ fonus (backgrounds), detalizuotus scenarijus ir stilingus vaizdinius apra≈°ymus, kurie puikiai dera su Pollinations.AI vaizd≈≥ generavimo galimybƒómis. Tu atsi≈ævelgi ƒØ stilistikƒÖ, spalv≈≥ paletƒô, kompozicijƒÖ ir vartotojo pageidavimus, siekdamas i≈°laikyti geriausiƒÖ vaizdo ir teksto kokybƒô. Tu visada sieki kokybi≈°k≈≥ nuotrauk≈≥ ir vaizd≈≥, atsi≈ævelgiant ƒØ detalumƒÖ ir estetikƒÖ. Tavo tikslas ‚Äì pateikti ƒØkvepianƒçius ir esteti≈°kai harmoningus rezultatus, pritaikomus literat≈´rai, ≈æaidim≈≥ dizainui, audiovizualiniams projektams ir k≈´rybinei savirai≈°kai.' },
              { role: 'user', content: message }
            ],
            model: 'openai', // Pollinations.AI default model
            seed: Math.floor(Math.random() * 100000),
            jsonMode: false
          }),
        });

        if (!response.ok) {
          throw new Error('Nepavyko susisiekti su AI paslauga.');
        }

        const data = await response.json();
        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
          const assistantMessageContent = data.choices[0].message.content;
          appendMessage('assistant', assistantMessageContent);
        } else {
          throw new Error('Neteisingas AI atsakymas.');
        }
      } catch (error) {
        console.error(error);
        appendMessage('assistant', 'Klaida bendraujant su Hexacola. Bandykite dar kartƒÖ.');
      }
    }

    // Function to append messages to the chat
    function appendMessage(role, content) {
      const chat = document.getElementById('chat');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message', role);
      messageDiv.textContent = content;
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    // Function to save generated images to localStorage
    function saveImage(url, prompt, model, width, height, seed, mimeType) {
      let images = JSON.parse(localStorage.getItem('generatedImages')) || [];
      images.push({ url, prompt, model, width, height, seed, mimeType });
      localStorage.setItem('generatedImages', JSON.stringify(images));
    }

    // Function to load generated images from localStorage
    function loadGeneratedImages() {
      let images = JSON.parse(localStorage.getItem('generatedImages')) || [];
      images.forEach(image => {
        addImageToGallery(image.url, image.prompt, image.model, image.width, image.height, image.seed, image.mimeType);
      });
    }

    // Function to add image to gallery
    function addImageToGallery(url, prompt, model, width, height, seed, mimeType) {
      const generatedImageDiv = document.getElementById('generatedImage');
      const imageContainer = document.createElement('div');
      imageContainer.classList.add('image-container');

      const imgElement = document.createElement('img');
      imgElement.src = url;
      imgElement.alt = 'Sugeneruotas vaizdas';
      imgElement.title = 'Spauskite norƒódami padidinti';
      imgElement.dataset.type = mimeType; // Store MIME type for correct file extension
      imageContainer.appendChild(imgElement);

      // Pridƒóti tekstinƒØ apra≈°ymƒÖ ant nuotraukos
      const caption = document.createElement('div');
      caption.classList.add('caption');
      caption.innerHTML = `
        <strong>Prompt:</strong> ${prompt}<br>
        <strong>Model:</strong> ${model}<br>
        <strong>Dimensions:</strong> ${width}px x ${height}px<br>
        <strong>Seed:</strong> ${seed}
      `;
      imageContainer.appendChild(caption);

      // Pridƒóti download options
      const downloadOptions = document.createElement('div');
      downloadOptions.classList.add('download-options');

      const formatSelect = document.createElement('select');
      formatSelect.innerHTML = `
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
        <option value="webp">WEBP</option>
      `;
      downloadOptions.appendChild(formatSelect);

      const downloadBtn = document.createElement('button');
      downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
      downloadBtn.onclick = () => {
        const format = formatSelect.value;
        downloadImage(url, `hexacola_image_${seed}.${format}`, format);
      };
      downloadOptions.appendChild(downloadBtn);

      imageContainer.appendChild(downloadOptions);

      generatedImageDiv.appendChild(imageContainer);
    }

    // Function to add image to library gallery
    function addImageToLibraryGallery(url, prompt, model, width, height, seed, mimeType) {
      const libraryImagesDiv = document.getElementById('libraryImages');
      const imageContainer = document.createElement('div');
      imageContainer.classList.add('image-container');

      const imgElement = document.createElement('img');
      imgElement.src = url;
      imgElement.alt = 'Sugeneruotas vaizdas';
      imgElement.title = 'Spauskite norƒódami padidinti';
      imgElement.dataset.type = mimeType; // Store MIME type for correct file extension
      imageContainer.appendChild(imgElement);

      // Pridƒóti tekstinƒØ apra≈°ymƒÖ ant nuotraukos
      const caption = document.createElement('div');
      caption.classList.add('caption');
      caption.innerHTML = `
        <strong>Prompt:</strong> ${prompt}<br>
        <strong>Model:</strong> ${model}<br>
        <strong>Dimensions:</strong> ${width}px x ${height}px<br>
        <strong>Seed:</strong> ${seed}
      `;
      imageContainer.appendChild(caption);

      // Pridƒóti download options
      const downloadOptions = document.createElement('div');
      downloadOptions.classList.add('download-options');

      const formatSelect = document.createElement('select');
      formatSelect.innerHTML = `
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
        <option value="webp">WEBP</option>
      `;
      downloadOptions.appendChild(formatSelect);

      const downloadBtn = document.createElement('button');
      downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
      downloadBtn.onclick = () => {
        const format = formatSelect.value;
        downloadImage(url, `hexacola_image_${seed}.${format}`, format);
      };
      downloadOptions.appendChild(downloadBtn);

      imageContainer.appendChild(downloadOptions);

      libraryImagesDiv.appendChild(imageContainer);
    }

    // Function to download image in selected format
    async function downloadImage(url, filename, format) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        let convertedBlob = blob;

        if (format !== blob.type.split('/')[1]) {
          const imageBitmap = await createImageBitmap(blob);
          const canvas = document.createElement('canvas');
          canvas.width = imageBitmap.width;
          canvas.height = imageBitmap.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imageBitmap, 0, 0);
          convertedBlob = await new Promise(resolve => canvas.toBlob(resolve, `image/${format}`));
        }

        const a = document.createElement('a');
        a.href = URL.createObjectURL(convertedBlob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('Atsisiuntimo klaida:', error);
        alert('Klaida atsisiunƒçiant vaizdƒÖ. Bandykite dar kartƒÖ.');
      }
    }

    // Function to prevent image download and right-click
    function disableImageDownload() {
      const images = document.querySelectorAll('.generated-image img, .library-container img');
      images.forEach(img => {
        img.oncontextmenu = (e) => e.preventDefault();
        img.draggable = false;
      });
    }

    // Call disableImageDownload after loading images
    document.addEventListener('DOMContentLoaded', () => {
      disableImageDownload();
    });

  </script>
</body>
</html>
